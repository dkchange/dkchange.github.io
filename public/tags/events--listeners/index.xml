<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Events &amp; Listeners on My New Hugo Site</title>
    <link>http://localhost:1313/tags/events--listeners/</link>
    <description>Recent content in Events &amp; Listeners on My New Hugo Site</description>
    <generator>Hugo</generator>
    <language>en-us</language>
    <lastBuildDate>Tue, 17 Dec 2019 16:03:31 +0000</lastBuildDate>
    <atom:link href="http://localhost:1313/tags/events--listeners/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>laravel使用事件和監聽</title>
      <link>http://localhost:1313/posts/laravel%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E5%92%8C%E7%9B%A3%E8%81%BD/</link>
      <pubDate>Tue, 17 Dec 2019 16:03:31 +0000</pubDate>
      <guid>http://localhost:1313/posts/laravel%E4%BD%BF%E7%94%A8%E4%BA%8B%E4%BB%B6%E5%92%8C%E7%9B%A3%E8%81%BD/</guid>
      <description>&lt;h1 id=&#34;前言&#34;&gt;前言&lt;/h1&gt;&#xA;&lt;p&gt;使用場景這樣的，有的時候controller使用者註冊完之後，除了要發信件給管理者，還有發LINE訊息給管理者，這些眾多需要做的事都塞在controller會讓controller很雜亂，整個不隸屬與該controller的兩件事，寫同一個controller裡面也不對，萬一很多地方要用到呢?&lt;/p&gt;&#xA;&lt;h1 id=&#34;創建事件建和監聽&#34;&gt;創建事件建和監聽&lt;/h1&gt;&#xA;&lt;p&gt;php artisan make:event NewCustomerHasRegisteredEvent&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;app\Events\NewCustomerHasRegisteredEvent.php&lt;/code&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-php&#34; data-lang=&#34;php&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; $coustmer;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;__construct&lt;/span&gt;($coustmer)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       $this&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;customer&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; $coustmer;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;php artisan make:listener WelcomeNewCustomer&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;app\Listeners\WelcomeNewCustomer.php&lt;/code&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-php&#34; data-lang=&#34;php&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;function&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;handle&lt;/span&gt;($event)&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   {&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       &lt;span style=&#34;color:#a6e22e&#34;&gt;sleep&lt;/span&gt;(&lt;span style=&#34;color:#ae81ff&#34;&gt;10&lt;/span&gt;);&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;       &lt;span style=&#34;color:#a6e22e&#34;&gt;Mail&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;to&lt;/span&gt;($event&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;customer&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;email&lt;/span&gt;)&lt;span style=&#34;color:#f92672&#34;&gt;-&amp;gt;&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;send&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;WelcomeNewUserMail&lt;/span&gt;());&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;   }&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;註冊此事件監聽&#34;&gt;註冊此事件監聽&lt;/h1&gt;&#xA;&lt;p&gt;&lt;code&gt;/app/Providers/EventServiceProvider.php&lt;/code&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-php&#34; data-lang=&#34;php&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;     &lt;span style=&#34;color:#66d9ef&#34;&gt;protected&lt;/span&gt; $listen &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; [&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a6e22e&#34;&gt;NewCustomerHasRegisteredEvent&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&amp;gt;&lt;/span&gt; [&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#a6e22e&#34;&gt;\App\Listeners\WelcomeNewCustomerListener&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;::&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;class&lt;/span&gt;,&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        ],&#xA;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ];&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;在這裡有一個方便的點就是，如果$listen陣列內容填的是全路徑的話&#xA;直接&lt;/p&gt;&#xA;&lt;pre&gt;&lt;code&gt;php artisan event:ganerate&#xD;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;就可以產生下面兩個檔案了，完全不用分別創建事件和監聽，如果事件和監聽很多的話，少打不少指令&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;app\Events\NewCustomerHasRegisteredEvent.php&lt;/code&gt;&#xA;&lt;code&gt;app\Listeners\WelcomeNewCustomer.php&lt;/code&gt;&lt;/p&gt;&#xA;&lt;h1 id=&#34;觸發事件&#34;&gt;觸發事件&lt;/h1&gt;&#xA;&lt;p&gt;在要使用的controller裡面添加&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-php&#34; data-lang=&#34;php&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;event&lt;/span&gt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;NewCustomerHasRegisteredEvent&lt;/span&gt;($customer));&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h1 id=&#34;queues&#34;&gt;Queues&lt;/h1&gt;&#xA;&lt;p&gt;有的時候事件的服務要經過很久才會有回應，總不能讓使用者等10秒以上吧，laravel有解決方法。話說PHP又沒有異步機制，要異步的話必須要靠別的線程?laravel如何實現呢?看樣子是利用排程去做&#xA;異步要依靠列隊&lt;/p&gt;&#xA;&lt;p&gt;&lt;code&gt;.env&lt;/code&gt;&#xA;QUEUE_CONNECTION=database&#xA;&lt;code&gt;app\Listeners\WelcomeNewCustomer.php&lt;/code&gt;&lt;/p&gt;&#xA;&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-php&#34; data-lang=&#34;php&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;WelcomeNewCustomerListener&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;implements&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;ShouldQueue&lt;/span&gt;&#xA;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;pre&gt;&lt;code&gt;php artisan queue:table&#xD;&#xA;php artisan migrate&#xD;&#xA;php artisan queue:work&#xD;&#xA;要在背景執行的話在後面加上sapce+&amp;amp;&#xD;&#xA;&#xD;&#xA;php artisan queue:work &amp;amp;&#xD;&#xA;列出執行中的排程&#xD;&#xA;&#xD;&#xA;jobs -l &#xD;&#xA;要儲存log的話&#xD;&#xA;&#xD;&#xA;php artisan queue:work &amp;gt; storage/logs/jobs.log &amp;amp;&#xD;&#xA;&lt;/code&gt;&lt;/pre&gt;&#xA;&lt;p&gt;排程執行失敗要怎麼知道?&#xA;這時候就要加個工具叫做supervisor排程關掉時他會替你重開&lt;/p&gt;</description>
    </item>
  </channel>
</rss>
